<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR GLB interactif</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    background: #000;
    touch-action: none; 
  }

  video {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 1;
  }

  canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 2;
    display: none; /* caché jusqu'au clic */
  }

  /* Logo preload en haut */
  #logo-preload {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%) scale(0);
    transition: transform 3s ease;
    z-index: 3;
  }
  #logo-preload.show {
    transform: translateX(-50%) scale(1);
  }
  #logo-preload img {
    width: auto;
    height: 50px;
  }

  /* Logo fixe en bas */
  #logo-bottom {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 3;
  }
  #logo-bottom img {
    width: auto;
    height: 30px;
  }

  #error {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 10px 20px;
    border-radius: 10px;
    display: none;
    z-index: 4;
    font-family: sans-serif;
  }
</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>

<!-- Logo preload en haut -->
<div id="logo-preload"><img src="LogoAr.png" alt="Logo Preload"></div>

<!-- Logo fixe en bas -->
<div id="logo-bottom"><img src="LogoAr.png" alt="Logo Bas"></div>

<div id="error"></div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

const video = document.getElementById('camera');
const errorMsg = document.getElementById('error');
const logoPreload = document.getElementById('logo-preload');
let renderer, scene, camera, model;

// === 1. Caméra arrière automatique ===
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = stream;
  } catch (err) {
    errorMsg.textContent = "Erreur caméra : " + err.message;
    errorMsg.style.display = "block";
  }
}
startCamera();

// === 2. Préload du logo en haut avec zoom 3 secondes ===
const imgLogo = new Image();
imgLogo.src = 'LogoAR.png';
imgLogo.onload = () => setTimeout(() => logoPreload.classList.add('show'), 100);

// === 3. Initialisation AR avec GLB ===
function initAR() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
  camera.position.z = 3;

  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.display = 'block';
  document.body.appendChild(renderer.domElement);

  // Lumières
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(1,1,2);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff, 0.5));

  // === Charger modèle GLB ===
  const loader = new GLTFLoader();
  loader.load(
    'https://example.com/ton_model.glb', // <-- mettre le lien de ton fichier GLB
    function(gltf) {
      model = gltf.scene;
      model.scale.set(1,1,1);
      scene.add(model);
    },
    undefined,
    function(error){
      console.error(error);
      errorMsg.textContent = "Erreur chargement GLB";
      errorMsg.style.display = "block";
    }
  );

  // === Gestes interactifs ===
  let startX=0, startY=0, posX=0, posY=0;
  let scale=1, rotation=0;
  let initialDistance=0, initialScale=1, initialRotation=0, initialAngle=0;

  function distance(touches){
    const [t1,t2]=touches;
    return Math.hypot(t2.clientX-t1.clientX, t2.clientY-t1.clientY);
  }
  function angle(touches){
    const [t1,t2]=touches;
    return Math.atan2(t2.clientY-t1.clientY, t2.clientX-t1.clientX);
  }

  document.addEventListener('touchstart', e=>{
    if(e.touches.length===1){
      startX = e.touches[0].clientX - posX;
      startY = e.touches[0].clientY - posY;
    } else if(e.touches.length===2){
      initialDistance = distance(e.touches);
      initialScale = scale;
      initialRotation = rotation;
      initialAngle = angle(e.touches);
    }
  });

  document.addEventListener('touchmove', e=>{
    e.preventDefault();
    if(!model) return;
    if(e.touches.length===1){
      posX = e.touches[0].clientX - startX;
      posY = e.touches[0].clientY - startY;
    } else if(e.touches.length===2){
      const newDist = distance(e.touches);
      scale = initialScale*(newDist/initialDistance);
      const newAngle = angle(e.touches);
      rotation = initialRotation + (newAngle-initialAngle)*(180/Math.PI);
    }
    model.position.x = (posX - window.innerWidth/2)/200;
    model.position.y = -(posY - window.innerHeight/2)/200;
    model.scale.set(scale,scale,scale);
    model.rotation.y = rotation * Math.PI/180;
  });

  // === Animation ===
  function animate(){
    requestAnimationFrame(animate);
    renderer.render(scene,camera);
  }
  animate();

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

// === 4. Afficher modèle après clic sur caméra ===
video.addEventListener('click', () => {
  if(!renderer) initAR();
});
</script>

</body>
</html>
