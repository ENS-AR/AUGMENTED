<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR avec logo animé + modèle 3D</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
    }

    video {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
    }

    /* === Logo fixe + animation preload === */
    #logo-bottom {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%) scale(1);
      z-index: 4;
      transition: all 1s ease;
      pointer-events: none;
    }

    #logo-bottom img {
      height: 25px;
      width: auto;
      transition: transform 1s ease;
    }

    #logo-bottom.animate {
      bottom: 45%;
      transform: translateX(-50%) scale(2);
    }

    /* === Conteneur du modèle 3D === */
    #model-container {
      position: absolute;
      top: 60%;
      left: 50%;
      width: 300px;
      height: 300px;
      transform: translate(-50%, -50%) rotate(0deg) scale(1);
      z-index: 3;
      display: none;
      opacity: 0;
      touch-action: none;
      will-change: transform;
      background: transparent;
    }

    model-viewer {
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
    }
  </style>

  <!-- Import du composant model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <video id="camera" autoplay playsinline></video>

  <!-- Conteneur du modèle 3D -->
  <div id="model-container">
    <model-viewer id="ar-model"
                  src="youtube_logo.glb"
                  alt="Modèle 3D"
                  ar
                  ar-modes="webxr scene-viewer quick-look"
                  camera-controls
                  autoplay
                  reveal="interaction"
                  shadow-intensity="1">
    </model-viewer>
  </div>

  <!-- Logo fixe (préload) -->
  <div id="logo-bottom"><img src="LogoAr.png" alt="Logo Bas"></div>

  <script>
    const video = document.getElementById('camera');
    const logo = document.getElementById('logo-bottom');
    const modelContainer = document.getElementById('model-container');

    // === 1. Ouvrir la caméra ===
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        video.srcObject = stream;
      } catch (err) {
        console.error("Erreur caméra :", err);
      }
    }
    startCamera();

    // === 2. Animation du logo (préload) ===
    setTimeout(() => { logo.classList.add('animate'); }, 100);

    // === 3. Afficher le modèle après animation ===
    setTimeout(() => {
      logo.classList.remove('animate');
      showModel3D();
    }, 3100);

    // === 4. Afficher le modèle 3D ===
    function showModel3D() {
      modelContainer.style.display = 'block';
      setTimeout(() => modelContainer.style.opacity = '1', 100);
      initGestures(modelContainer);
    }

    // === 5. Gestes tactiles (déplacement / zoom / rotation) ===
    function initGestures(el) {
      let dx = 0, dy = 0;
      let scale = 1, rotation = 0;
      let startX = 0, startY = 0;
      let initDist = 0, initScale = 1, initAngle = 0, initRotation = 0;

      function getDistance(touches) {
        const [t1, t2] = touches;
        return Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
      }
      function getAngle(touches) {
        const [t1, t2] = touches;
        return Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
      }

      el.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          startX = e.touches[0].clientX - dx;
          startY = e.touches[0].clientY - dy;
        } else if (e.touches.length === 2) {
          initDist = getDistance(e.touches);
          initScale = scale;
          initAngle = getAngle(e.touches);
          initRotation = rotation;
        }
      }, { passive: false });

      el.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length === 1) {
          dx = e.touches[0].clientX - startX;
          dy = e.touches[0].clientY - startY;
        } else if (e.touches.length === 2) {
          const newDist = getDistance(e.touches);
          if (initDist > 0) {
            scale = Math.max(0.2, initScale * (newDist / initDist));
          }
          const newAngle = getAngle(e.touches);
          rotation = initRotation + (newAngle - initAngle) * (180 / Math.PI);
        }
        updateTransform();
      }, { passive: false });

      // Double tap pour réinitialiser
      let lastTap = 0;
      el.addEventListener('touchend', () => {
        const now = Date.now();
        if (now - lastTap < 300) {
          dx = 0; dy = 0; scale = 1; rotation = 0;
          updateTransform();
        }
        lastTap = now;
      });

      function updateTransform() {
        el.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) rotate(${rotation}deg) scale(${scale})`;
      }
    }
  </script>
</body>
</html>
